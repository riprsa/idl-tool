<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Solana IDL Viewer</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .section {
        margin-bottom: 20px;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .section h2 {
        margin-top: 0;
        margin-bottom: 20px;
        color: #1a1a1a;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
      }
      .section h2::after {
        content: "â–¼";
        font-size: 0.8em;
        transition: transform 0.2s;
      }
      .section.collapsed h2::after {
        transform: rotate(-90deg);
      }
      .section-content {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        padding: 0;
      }
      @media (max-width: 1024px) {
        .section-content {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      @media (max-width: 640px) {
        .section-content {
          grid-template-columns: 1fr;
        }
      }
      .item {
        margin: 0;
        padding: 20px;
        margin-bottom: 20px;
        background: #f8f9fa;
        border-radius: 6px;
        display: flex;
        flex-direction: column;
      }
      .item h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #2c3e50;
      }
      .field {
        margin: 8px 0;
        padding: 12px;
        background: white;
        border-radius: 4px;
      }
      .field:first-child {
        margin-top: 0;
      }
      .field:last-child {
        margin-bottom: 0;
      }
      .field-name {
        font-weight: bold;
        color: #2c3e50;
        margin-right: 8px;
      }
      .field-type {
        color: #666;
        font-family: monospace;
      }
      .docs {
        color: #666;
        font-style: italic;
        margin: 8px 0;
      }
      .error {
        color: #dc3545;
        padding: 10px;
        background-color: #f8d7da;
        border-radius: 5px;
        margin: 10px 0;
      }
      .file-input-container {
        margin: 20px 0;
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      input[type="file"] {
        padding: 12px;
        border: 2px dashed #ccc;
        border-radius: 4px;
        width: 100%;
        box-sizing: border-box;
      }
      .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        margin-left: 8px;
      }
      .badge.writable {
        background: #28a745;
        color: white;
      }
      .badge.signer {
        background: #007bff;
        color: white;
      }
      .badge.optional {
        background: #6c757d;
        color: white;
      }
      h4 {
        margin: 15px 0 10px 0;
        color: #2c3e50;
      }
      h4:first-child {
        margin-top: 0;
      }
    </style>
  </head>
  <body>
    <h1>Solana IDL Viewer</h1>

    <div class="file-input-container">
      <input type="file" id="idlFile" accept=".json" />
    </div>

    <div id="idlContent">
      <div id="accounts" class="section">
        <h2>Accounts</h2>
        <div id="accountsContent" class="section-content"></div>
      </div>

      <div id="instructions" class="section">
        <h2>Instructions</h2>
        <div id="instructionsContent" class="section-content"></div>
      </div>

      <div id="types" class="section">
        <h2>Types</h2>
        <div id="typesContent" class="section-content"></div>
      </div>

      <div id="errors" class="section">
        <h2>Errors</h2>
        <div id="errorsContent" class="section-content"></div>
      </div>

      <div id="events" class="section">
        <h2>Events</h2>
        <div id="eventsContent" class="section-content"></div>
      </div>
    </div>

    <script>
      // Add click handlers for collapsible sections
      document.querySelectorAll(".section h2").forEach((header) => {
        header.addEventListener("click", () => {
          const section = header.parentElement;
          section.classList.toggle("collapsed");
        });
      });

      document
        .getElementById("idlFile")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              const idl = JSON.parse(e.target.result);
              displayIDL(idl);
            } catch (error) {
              showError("Error parsing JSON file: " + error.message);
            }
          };
          reader.readAsText(file);
        });

      function displayIDL(idl) {
        clearAllSections();

        // Handle different IDL formats
        // Format 1: { program: { accounts, instructions, ... } }
        // Format 2: { accounts, instructions, ... } (direct root level)
        const programData = idl.program || idl;

        // Display accounts
        if (programData.accounts) {
          displayAccounts(programData.accounts);
        }

        // Display instructions
        if (programData.instructions) {
          displayInstructions(programData.instructions);
        }

        // Display types
        if (programData.types || programData.definedTypes) {
          // Handle both formats for types
          displayTypes(programData.types || programData.definedTypes);
        }

        // Display errors
        if (programData.errors) {
          displayErrors(programData.errors);
        }

        // Display events
        if (programData.events) {
          displayEvents(programData.events);
        }
      }

      function displayAccounts(accounts) {
        const container = document.getElementById("accountsContent");
        accounts.forEach((account) => {
          const item = document.createElement("div");
          item.className = "item";

          let html = `<h3>${account.name}</h3>`;
          if (account.docs && account.docs.length > 0) {
            html += `<div class="docs">${account.docs.join("<br>")}</div>`;
          }

          // Handle both formats for account data
          // Format 1: account.data.fields
          // Format 2: account.type.fields
          const fields = account.data?.fields || account.type?.fields;
          if (fields) {
            html += '<div class="fields">';
            fields.forEach((field) => {
              html += `
                <div class="field">
                  <span class="field-name">${field.name}</span>: 
                  <span class="field-type">${formatType(field.type)}</span>
                  ${
                    field.docs && field.docs.length > 0
                      ? `<div class="docs">${field.docs.join("<br>")}</div>`
                      : ""
                  }
                </div>
              `;
            });
            html += "</div>";
          }

          item.innerHTML = html;
          container.appendChild(item);
        });
      }

      function displayInstructions(instructions) {
        const container = document.getElementById("instructionsContent");
        instructions.forEach((instruction) => {
          const item = document.createElement("div");
          item.className = "item";

          let html = `<h3>${instruction.name}</h3>`;
          if (instruction.docs && instruction.docs.length > 0) {
            html += `<div class="docs">${instruction.docs.join("<br>")}</div>`;
          }

          if (instruction.accounts && instruction.accounts.length > 0) {
            html += '<h4>Accounts:</h4><div class="accounts">';
            instruction.accounts.forEach((account) => {
              // Handle both formats for account properties
              // Format 1: isWritable, isSigner, isOptional
              // Format 2: writable, signer, optional
              const isWritable = account.isWritable || account.writable;
              const isSigner = account.isSigner || account.signer;
              const isOptional = account.isOptional || account.optional;

              html += `
                <div class="field">
                  <span class="field-name">${account.name}</span>
                  ${
                    isWritable
                      ? '<span class="badge writable">writable</span>'
                      : ""
                  }
                  ${isSigner ? '<span class="badge signer">signer</span>' : ""}
                  ${
                    isOptional
                      ? '<span class="badge optional">optional</span>'
                      : ""
                  }
                  ${
                    account.docs && account.docs.length > 0
                      ? `<div class="docs">${account.docs.join("<br>")}</div>`
                      : ""
                  }
                </div>
              `;
            });
            html += "</div>";
          }

          if (instruction.args && instruction.args.length > 0) {
            html += '<h4>Arguments:</h4><div class="arguments">';
            instruction.args.forEach((arg) => {
              html += `
                <div class="field">
                  <span class="field-name">${arg.name}</span>: 
                  <span class="field-type">${formatType(arg.type)}</span>
                  ${
                    arg.docs && arg.docs.length > 0
                      ? `<div class="docs">${arg.docs.join("<br>")}</div>`
                      : ""
                  }
                </div>
              `;
            });
            html += "</div>";
          }

          item.innerHTML = html;
          container.appendChild(item);
        });
      }

      function displayTypes(types) {
        const container = document.getElementById("typesContent");
        types.forEach((type) => {
          const item = document.createElement("div");
          item.className = "item";

          let html = `<h3>${type.name}</h3>`;
          if (type.docs && type.docs.length > 0) {
            html += `<div class="docs">${type.docs.join("<br>")}</div>`;
          }

          // Handle both formats for type data
          // Format 1: type.type.kind === 'enumTypeNode'
          // Format 2: type.type.kind === 'enum'
          const typeData = type.type;
          if (typeData) {
            if (typeData.kind === "enumTypeNode" || typeData.kind === "enum") {
              html += '<div class="enum-variants">';
              typeData.variants.forEach((variant) => {
                html += `<div class="field">${variant.name}</div>`;
              });
              html += "</div>";
            } else if (
              typeData.kind === "struct" ||
              typeData.kind === "structTypeNode"
            ) {
              html += '<div class="struct-fields">';
              typeData.fields.forEach((field) => {
                html += `
                  <div class="field">
                    <span class="field-name">${field.name}</span>: 
                    <span class="field-type">${formatType(field.type)}</span>
                    ${
                      field.docs && field.docs.length > 0
                        ? `<div class="docs">${field.docs.join("<br>")}</div>`
                        : ""
                    }
                  </div>
                `;
              });
              html += "</div>";
            }
          }

          item.innerHTML = html;
          container.appendChild(item);
        });
      }

      function displayErrors(errors) {
        const container = document.getElementById("errorsContent");
        errors.forEach((error) => {
          const item = document.createElement("div");
          item.className = "item";

          // Handle both formats for error data
          // Format 1: error.name, error.code, error.message
          // Format 2: error.name, error.code, error.msg
          let html = `<h3>${error.name} (Code: ${error.code})</h3>`;
          if (error.message || error.msg) {
            html += `<div class="error">${error.message || error.msg}</div>`;
          }
          if (error.docs && error.docs.length > 0) {
            html += `<div class="docs">${error.docs.join("<br>")}</div>`;
          }

          item.innerHTML = html;
          container.appendChild(item);
        });
      }

      function displayEvents(events) {
        const container = document.getElementById("eventsContent");
        events.forEach((event) => {
          const item = document.createElement("div");
          item.className = "item";

          let html = `<h3>${event.name}</h3>`;
          if (event.docs && event.docs.length > 0) {
            html += `<div class="docs">${event.docs.join("<br>")}</div>`;
          }

          // Handle both formats for event data
          // Format 1: event.type.fields
          // Format 2: event.fields
          const fields = event.type?.fields || event.fields;
          if (fields) {
            html += '<div class="fields">';
            fields.forEach((field) => {
              html += `
                <div class="field">
                  <span class="field-name">${field.name}</span>: 
                  <span class="field-type">${formatType(field.type)}</span>
                  ${
                    field.docs && field.docs.length > 0
                      ? `<div class="docs">${field.docs.join("<br>")}</div>`
                      : ""
                  }
                </div>
              `;
            });
            html += "</div>";
          }

          item.innerHTML = html;
          container.appendChild(item);
        });
      }

      function formatType(type) {
        if (!type) return "";

        // Handle both string and object type formats
        if (typeof type === "string") {
          return type;
        }

        switch (type.kind) {
          case "publicKeyTypeNode":
          case "pubkey":
            return "PublicKey";
          case "numberTypeNode":
            return `${type.format}${type.endian ? ` (${type.endian})` : ""}`;
          case "stringTypeNode":
            return `String (${type.encoding})`;
          case "definedTypeLinkNode":
            return type.name;
          case "sizePrefixTypeNode":
            return `SizePrefixed<${formatType(type.type)}>`;
          case "array":
            return `Array<${formatType(type[0])}, ${type[1]}>`;
          default:
            return type.kind;
        }
      }

      function clearAllSections() {
        const sections = [
          "accountsContent",
          "instructionsContent",
          "typesContent",
          "errorsContent",
          "eventsContent",
        ];
        sections.forEach((section) => {
          document.getElementById(section).innerHTML = "";
        });
      }

      function showError(message) {
        const errorDiv = document.createElement("div");
        errorDiv.className = "error";
        errorDiv.textContent = message;
        document.body.insertBefore(
          errorDiv,
          document.getElementById("idlContent")
        );
      }
    </script>
  </body>
</html>
